<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teachable Machine - Webcam & Upload</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    #video-container, #upload-container { margin: 20px auto; }
    #label-container { margin-top: 16px; font-size: 18px; white-space: pre-line; }
    canvas, video, img { max-width: 100%; }
    button { margin: 6px; padding: 10px 16px; font-size: 16px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .hint { font-size: 13px; opacity: 0.75; margin-top: 6px; }
    .box { background: #fff; border-radius: 12px; padding: 14px; max-width: 680px; margin: 14px auto; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <h2>üåø ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û</h2>

  <div class="box">
    <div id="video-container">
      <button id="btnStartWebcam" onclick="startWebcam()" disabled>üé• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
      <button id="btnStopWebcam" onclick="stopWebcam()" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
      <div class="hint">‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‚Äú‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‚Äù</div>

      <video id="webcam" autoplay playsinline width="320" height="240" style="display:none;"></video>
      <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    </div>

    <hr style="margin:16px 0; opacity:0.25;" />

    <div id="upload-container">
      <input type="file" id="imageUpload" accept="image/*" />
      <button id="btnProcess" onclick="processUploadedImage()" disabled>üß† ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
      <div class="hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‚Äù</div>

      <img id="uploadedImage" alt="uploaded" style="display:none; margin-top:10px; max-height:320px;" />
    </div>
  </div>

  <div id="label-container">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ + ‡πÇ‡∏°‡πÄ‡∏î‡∏•‚Ä¶</div>

  <!-- ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ü‡∏•‡πå UMD/Minified ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô error "exports is not defined" -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <script>
    // ‚úÖ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /)
    const modelURL = "https://teachablemachine.withgoogle.com/models/m23gUS6VV/";

    let model = null;
    let webcamStream = null;
    let predictTimer = null;
    let uploadedFile = null;

    const el = {
      status: () => document.getElementById("label-container"),
      btnStart: () => document.getElementById("btnStartWebcam"),
      btnStop: () => document.getElementById("btnStopWebcam"),
      btnProcess: () => document.getElementById("btnProcess"),
      webcam: () => document.getElementById("webcam"),
      canvas: () => document.getElementById("canvas"),
      img: () => document.getElementById("uploadedImage"),
      file: () => document.getElementById("imageUpload")
    };

    function setStatus(text) { el.status().innerText = text; }
    function setReady(enabled) {
      el.btnStart().disabled = !enabled;
      el.btnProcess().disabled = !enabled;
      el.btnStop().disabled = true;
    }

    async function init() {
      setReady(false);
      setStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ + ‡πÇ‡∏°‡πÄ‡∏î‡∏•‚Ä¶");

      try {
        // ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        if (!window.tf) throw new Error("TensorFlow.js (tf) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°");
        if (!window.tmImage) throw new Error("tmImage ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÑ‡∏ü‡∏•‡πå teachablemachine-image ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)");

        model = await tmImage.load(modelURL + "model.json", modelURL + "metadata.json");
        console.log("‚úÖ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        setStatus("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
        setReady(true);
      } catch (err) {
        console.error("‚ùå init error:", err);
        setStatus(
          "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•/‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n" +
          "‡πÄ‡∏ä‡πá‡∏Å 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ:\n" +
          "1) ‡πÄ‡∏õ‡∏¥‡∏î DevTools > Network ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå tf.min.js ‡πÅ‡∏•‡∏∞ teachablemachine-image.min.js ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°\n" +
          "2) ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ AdBlock/Privacy extension ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß\n" +
          "3) ‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤ modelURL ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /\n\n" +
          "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: " + (err?.message || err)
        );
      }
    }
    window.addEventListener("load", init);

    async function startWebcam() {
      if (!model) { setStatus("‚è≥ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à"); return; }
      stopWebcam();

      try {
        webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
        const webcam = el.webcam();
        webcam.srcObject = webcamStream;
        webcam.style.display = "block";

        const canvas = el.canvas();
        canvas.style.display = "block";
        el.btnStop().disabled = false;

        predictTimer = setInterval(async () => {
          const ctx = canvas.getContext("2d");
          ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
          const prediction = await model.predict(canvas);
          showResult(prediction);
        }, 500);
      } catch (err) {
        console.error("‚ùå webcam error:", err);
        setStatus("‚ùå ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
        stopWebcam();
      }
    }

    function stopWebcam() {
      if (predictTimer) { clearInterval(predictTimer); predictTimer = null; }
      if (webcamStream) { webcamStream.getTracks().forEach(t => t.stop()); webcamStream = null; }
      const webcam = el.webcam();
      const canvas = el.canvas();
      if (webcam) { webcam.srcObject = null; webcam.style.display = "none"; }
      if (canvas) { canvas.style.display = "none"; }
      el.btnStop().disabled = true;
    }

    el.file().addEventListener("change", (event) => {
      uploadedFile = event.target.files?.[0] || null;
      const img = el.img();

      if (!uploadedFile) { img.style.display = "none"; return; }
      img.src = URL.createObjectURL(uploadedFile);
      img.onload = () => { img.style.display = "block"; };
    });

    async function processUploadedImage() {
      if (!model) { setStatus("‚è≥ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à"); return; }
      if (!uploadedFile) { setStatus("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞"); return; }

      const img = el.img();
      if (!img.complete) { setStatus("‚è≥ ‡∏†‡∏≤‡∏û‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"); return; }

      try {
        const prediction = await model.predict(img);
        showResult(prediction);
      } catch (err) {
        console.error("‚ùå predict error:", err);
        setStatus("‚ùå ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î Console ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î");
      }
    }

    function showResult(prediction) {
      const sorted = [...prediction].sort((a,b) => b.probability - a.probability);
      const top = sorted[0];
      const lines = sorted.map(p => `${p.className}: ${Math.round(p.probability * 100)}%`).join("\n");
      setStatus(`‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Top-1): ${top.className} (${Math.round(top.probability*100)}%)\n\n${lines}`);
    }
  </script>
</body>
</html>
